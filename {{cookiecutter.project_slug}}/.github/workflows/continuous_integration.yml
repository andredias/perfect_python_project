name: Continuous Integration

on: [push]

jobs:

    lint_and_test:
        runs-on: ubuntu-latest
        steps:

            - name: Check out repository
              uses: actions/checkout@v5

            - name: Set up python
              uses: actions/setup-python@v6
              with:
                  python-version-file: "pyproject.toml"

            - name: Install uv
              uses: astral-sh/setup-uv@v6
              with:
                  version: "0.9.8"
                  enable-cache: true

            - name: Install dependencies
              run: uv sync --locked --no-install-project

            - name: Testing
              run: uv run --locked make test

            - name: Linting
              run: uv run --locked make lint

            - name: Auditing
              run: uv run make audit

            - name: Building
              run: docker compose build

            - name: Smoke Test
              run: uv run make smoke_test

            - name: Minimize uv cache
              run: uv cache prune --ci
